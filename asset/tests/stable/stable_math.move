#[test_only]
module clamm::stable_math_tests {

  use sui::clock;
  use sui::tx_context;
  use sui::test_utils::assert_eq; 

  use clamm::stable_math::{a, y, invariant_, y_lp, y_d};

  #[test]
  fun test_a() {
    let c = clock::create_for_testing(&mut tx_context::dummy());

    clock::set_for_testing(&mut c, 50);

    // t1 > current_time
    // A0 > A1
    assert_eq(
      a(20, 10, 15, 100, &c),
      18
    );
    
    // t1 > current_time
    // A0 > A1
    assert_eq(
      a(37, 10, 45, 100, &c),
      40
    );

    assert_eq(
      a(0, 0, 0, 0, &c),
      0
    );

    clock::set_for_testing(&mut c, 100);

    // current_time > t1
    assert_eq(
      a(0, 0, 15, 99, &c),
      15
    );

    clock::destroy_for_testing(c);
  }

  #[test]
  fun test_invariant() {
    
    assert_eq(
      invariant_(
        255,
        vector[
          45128763921876458230192756389561204,
          892347610982734610982346198237461,
          7098237461098237461098237461098
        ]
      ),
    19835507236928744512883382297835175
    );

    assert_eq(
      invariant_(
        17,
        vector[
          92756389561204876543891027456389,
          56789012345678901234567890123456,
          7098237461098237461098237461098
        ]
      ),
    149800434007778834198060138210028
    );    

    assert_eq(
      invariant_(
        9,
        vector[
          987654321098765,
          384109823746109,
          752784590271893
        ]
      ),
     2107803805217679
    );        

    assert_eq(
      invariant_(
        0,
        vector[
          0,
          0,
          0
        ]
      ),
    0
    );    
  }  


#[test]
fun test_y() {
  assert_eq(
    y(
        17,
        0,
        1,
        1234567,
        vector[
          987654321098765,
          384109823746109,
          752784590271893
        ]
      ),  
      3955354743869981221
    );

    assert_eq(
      y(
        17,
        0,
        2,
        1234567,
        vector[
          987654321098765,
          384109823746109,
          752784590271893
        ]
      ),  
       5537156950223067728
    );   

    assert_eq(
      y(
        17,
        1,
        2,
        1234567,
        vector[
          987654321098765,
          384109823746109,
          752784590271893
        ]
      ),  
       3453139248708933189
    );      

    assert_eq(
      y(
        17,
        2,
        1,
        1234567,
        vector[
          987654321098765,
          384109823746109,
          752784590271893
        ]
      ),  
       3453139248708933189
    );      
  }

#[test]
fun test_y_lp() {
    assert_eq(
      y_lp(
        17,
        0,
        vector[987654321098765, 384109823746109, 752784590271893],
        1234567,
        123456798
      ),  
       966007855963808
    ); 

    assert_eq(
      y_lp(
        17,
        1,
        vector[987654321098765, 384109823746109, 752784590271893],
        1234567,
        123456798
      ),  
       364060296412639
    );     

    assert_eq(
      y_lp(
        17,
        2,
        vector[987654321098765, 384109823746109, 752784590271893],
        1234567,
        123456798
      ),  
       731467394556920
    );   

    assert_eq(
      y_lp(
        17,
        2,
        vector[987654321098765, 384109823746109, 752784590271893],
        2617182,
        123456798
      ),  
       707625634228030
    );   

    assert_eq(
      y_lp(
        17,
        2,
        vector[987654321098765, 384109823746109, 752784590271893],
        0,
        123456798
      ),  
       752784590271893
    );  

    assert_eq(
      y_lp(
        17,
        1,
        vector[987654321098765, 384109823746109, 752784590271893],
        0,
        123456798
      ),  
       384109823746109
    );     

    assert_eq(
      y_lp(
        17,
        0,
        vector[987654321098765, 384109823746109, 752784590271893],
        0,
        123456798
      ),  
       987654321098765
    );               
}  

#[test]
fun test_y_d() {
    assert_eq(
      y_d(
        33,
        0,
        vector[987654321098765, 384109823746109, 752784590271893],
        123456789
      ),  
       0
    );   

    assert_eq(
      y_d(
        33,
        0,
        vector[987654321098765, 384109823746109, 752784590271893],
        987654321098765
      ),  
        7389326498921
    );    

    assert_eq(
      y_d(
        33,
        0,
        vector[987654321098765, 384109823746109, 752784590271893],
        1283950617428394
      ),  
         156547623622838
    );      
}

 #[test]
 #[expected_failure(abort_code = clamm::errors::SAME_COIN_INDEX, location = clamm::stable_math)] 
 fun test_y_same_coin() {
      y(
        0,
        1,
        1,
        0,
        vector[]
      );
 }
  
}